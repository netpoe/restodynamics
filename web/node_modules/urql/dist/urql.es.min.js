import{make as r,pipe as e,onPush as n,onEnd as t,subscribe as o,share as i,filter as a,map as u,tap as c,merge as s,mergeMap as f,takeUntil as p,makeSubject as v,onStart as d,take as h,toPromise as l}from"wonka";import{GraphQLError as y,print as m,visit as x}from"graphql";import g from"fast-json-stable-stringify";import w from"graphql-tag";import{createContext as O,useRef as b,useState as k,useCallback as E,useLayoutEffect as q,useEffect as N,useMemo as S,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED as _,useContext as j}from"react";function P(){return(P=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(r[t]=n[t])}return r}).apply(this,arguments)}var C=function(r,e){var n="";return void 0!==r?n="[Network] "+r.message:(void 0!==e&&e.forEach(function(r){n+="[GraphQL] "+r.message+"\n"}),n.trim())},D=function(r){return"string"==typeof r?new y(r):"object"==typeof r&&r.message?new y(r.message,r.nodes,r.source,r.positions,r.path,r.originalError,r.extensions||{}):r};function Q(){return this.message}var M=function(r){function e(e){var n=e.networkError,t=e.response,o=(e.graphQLErrors||[]).map(D),i=C(n,o);r.call(this,i),this.name="CombinedError",this.message=i,this.graphQLErrors=o,this.networkError=n,this.response=t}return r&&(e.__proto__=r),(e.prototype=Object.create(r&&r.prototype)).constructor=e,e.prototype.toString=Q,e}(Error),R=function(r){for(var e=5381,n=0,t=0|r.length;n<t;n++)e=(e<<5)+e+r.charCodeAt(n);return e>>>0},A=Object.create(null);function L(r,e){return r+(void 0!==e.name?e.name.value:"")}var W=function(r,e){var n=function(r){if(void 0!==r.__key)return r.__key;var e=r.definitions.reduce(L,"");if("production"!==process.env.NODE_ENV&&""!==e){var n=m(r);e in A?A[e]!==n&&console.warn("Warning: Encountered multiple DocumentNodes with the same name."):A[e]=n}""===e&&(e=m(r));var t=R(e);return r.__key=t,t}(r);return null==e?n:R(""+n+g(e))},F=function(r,e){var n="string"==typeof r?w([r]):r;return{key:W(n,e),query:n,variables:e||{}}},U=function(r,e){return P({},r,{context:P({},r.context,{meta:P({},r.context.meta,e)})})},$=function(r,e){if(void 0===e&&(e=[]),Array.isArray(r))r.forEach(function(r){return $(r,e)});else if("object"==typeof r&&null!==r)for(var n in r)if(Object.prototype.hasOwnProperty.call(r,n)){var t=r[n];"__typename"===n&&"string"==typeof t?e.push(t):"object"==typeof t&&null!==t&&$(t,e)}return e};function V(r,e,n){return n.indexOf(r)===e}var I=function(r){return $(r).filter(V)};function T(r){return"Field"===r.kind&&"__typename"===r.name.value}var G=function(r){return void 0!==r.selectionSet&&(r.selectionSet.selections.some(T)?r:P({},r,{selectionSet:P({},r.selectionSet,{selections:r.selectionSet.selections.concat([{kind:"Field",name:{kind:"Name",value:"__typename"}}])})}))},H=function(r){return x(r,{Field:G,InlineFragment:G,OperationDefinition:G})},J=function(){},Y=function(r){var e=r.operationName;return"subscription"!==e&&"query"!==e};function z(r){return""+r}var B=function(r){var e=r.error,n={data:r.data,error:void 0};return void 0!==e&&(n.error={networkError:""+e.networkError,graphQLErrors:e.graphQLErrors.map(z)}),n},K=function(r,e){var n=e.error,t={operation:r,data:e.data,extensions:void 0,error:void 0};return void 0!==n&&(t.error=new M({networkError:new Error(n.networkError),graphQLErrors:n.graphQLErrors})),t},X=function(r){var n={},t=function(r){return!Y(r)&&void 0!==n[r.key]};function o(r){return!t(r)}function f(r){return t(r)}function p(r){return K(r,n[r.key])}function v(r){var e=r.operation;if(!Y(e)){var t=B(r);n[e.key]=t}}function d(r){delete n[r.operation.key]}var h=function(n){var t=n.client,h=n.forward;return function(n){var l=r&&"boolean"==typeof r.isClient?!!r.isClient:!t.suspense,y=i(n),m=e(y,a(o),h),x=e(y,a(f),u(p));return l?x=e(x,c(d)):m=e(m,c(v)),s([m,x])}};return h.restoreData=function(r){return P(n,r)},h.extractData=function(){return P({},n)},r&&r.initialState&&h.restoreData(r.initialState),h},Z=function(r){var e=r.operationName;return"mutation"!==e&&"query"!==e};function rr(r){return P({},r,{query:H(r.query)})}function er(r){return Z(r)}function nr(r){return U(r,{cacheOutcome:"miss"})}var tr=function(r){var n=r.forward,t=r.client,o=new Map,f=Object.create(null),p=rr,v=ir(o,f,t),d=ar(o,f),h=function(r){var e=r.context.requestPolicy;return"query"===r.operationName&&"network-only"!==e&&("cache-only"===e||o.has(r.key))};function l(r){return!Z(r)&&h(r)}function y(r){var e=r.context,n=o.get(r.key);return"cache-and-network"===e.requestPolicy&&or(t,r),void 0!==n?P({},n,{operation:U(n.operation,{cacheOutcome:"hit"})}):{data:void 0,error:void 0,extensions:void 0,operation:U(r,{cacheOutcome:"miss"})}}function m(r){return!Z(r)&&!h(r)}function x(r){r.operation&&"mutation"===r.operation.operationName?v(r):r.operation&&"query"===r.operation.operationName&&d(r)}return function(r){var t=i(r),o=e(t,a(l),u(y)),f=e(s([e(t,a(m),u(p)),e(t,a(er))]),u(nr),n,c(x));return s([o,f])}},or=function(r,e){return r.reexecuteOperation(P({},e,{context:P({},e.context,{requestPolicy:"network-only"})}))},ir=function(r,e,n){function t(e){if(r.has(e)){var t=r.get(e).operation;r.delete(e),or(n,t)}}return function(r){var n=new Set;function o(r){return n.add(r)}I(r.data).forEach(function(r){var n=e[r]||(e[r]=new Set);n.forEach(o),n.clear()}),n.forEach(t)}},ar=function(r,e){return function(n){var t=n.operation,o=n.data;void 0!==o&&(r.set(t.key,{operation:t,data:o,error:n.error}),I(n.data).forEach(function(r){(e[r]||(e[r]=new Set)).add(t.key)}))}},ur=function(r){return"subscription"===r.operationName};function cr(r){return!ur(r)}var sr=function(n){var t=n.forwardSubscription;function o(e){var n=t({key:e.key.toString(36),query:m(e.query),variables:e.variables,context:P({},e.context)});return r(function(r){var t=r[0],o=n.subscribe({next:function(r){return t({operation:e,data:r.data||void 0,error:Array.isArray(r.errors)?new M({graphQLErrors:r.errors,response:void 0}):void 0,extensions:"object"==typeof r.extensions&&null!==r.extensions?r.extensions:void 0})},error:function(r){return t({operation:e,data:void 0,extensions:void 0,error:new M({networkError:r,response:void 0})})},complete:r[1]});return function(){return o.unsubscribe()}})}return function(r){var n=r.forward,t=o;return function(r){var o=i(r),u=e(o,a(ur),f(function(r){var n=r.key,i=e(o,a(function(r){return"teardown"===r.operationName&&r.key===n}));return e(t(r),p(i))})),c=e(o,a(cr),n);return s([u,c])}}};function fr(r){return console.log("[Exchange debug]: Incoming operation: ",r)}function pr(r){return console.log("[Exchange debug]: Completed operation: ",r)}var vr=function(r){var n=r.forward;return function(r){return e(r,c(fr),n,c(pr))}},dr=function(r){var n=r.forward,t=new Set,o=function(r){var e=r.key,n=r.operationName;if("teardown"===n)return t.delete(e),!0;if("query"!==n)return!0;var o=t.has(e);return t.add(e),!o},i=function(r){t.delete(r.operation.key)};return function(r){var t=e(r,a(o));return e(n(t),c(i))}};function hr(r){var e=r.operationName;return"query"===e||"mutation"===e}var lr=function(r){var n=r.forward,t=hr;function o(r){return!t(r)}return function(r){var u=i(r),c=e(u,a(t),f(function(r){var n=r.key,t=e(u,a(function(r){return"teardown"===r.operationName&&r.key===n}));return e(yr(r),p(t))})),v=e(u,a(o),n);return s([c,v])}},yr=function(e){if("subscription"===e.operationName)throw new Error("Received a subscription operation in the httpExchange. You are probably trying to create a subscription. Have you added a subscriptionExchange?");return r(function(r){var n=r[0],t=r[1],o="undefined"!=typeof AbortController?new AbortController:void 0,i=e.context,a="function"==typeof i.fetchOptions?i.fetchOptions():i.fetchOptions||{},u=P({body:JSON.stringify({query:m(e.query),variables:e.variables}),method:"POST"},a,{headers:P({"content-type":"application/json"},a.headers),signal:void 0!==o?o.signal:void 0}),c=Date.now();return mr(e,u).then(function(r){void 0!==r&&n(P({},r,{operation:U(r.operation,{networkLatency:Date.now()-c})})),t()}),function(){void 0!==o&&o.abort()}})},mr=function(r,e){var n,t=r.context;return(t.fetch||fetch)(t.url,e).then(function(r){return n=r,xr(e.redirect,r),r.json()}).then(function(e){return{operation:r,data:e.data,error:Array.isArray(e.errors)?new M({graphQLErrors:e.errors,response:n}):void 0,extensions:"object"==typeof e.extensions&&null!==e.extensions?e.extensions:void 0}}).catch(function(e){if("AbortError"!==e.name)return{operation:r,data:void 0,error:new M({networkError:e,response:n}),extensions:void 0}})},xr=function(r,e){if(void 0===r&&(r="follow"),e.status<200||e.status>=("manual"===r?400:300))throw new Error(e.statusText)};function gr(r){var e=r.operationName;"teardown"!==e&&"production"!==process.env.NODE_ENV&&console.warn('No exchange has handled operations of type "'+e+"\". Check whether you've added an exchange responsible for these operations.")}function wr(){return!1}var Or=function(r){return e(r,c(gr),a(wr))},br=function(r){return 1===r.length?r[0]:function(e){var n=e.client;return r.reduceRight(function(r,e){return e({client:n,forward:r})},e.forward)}},kr=[dr,tr,lr],Er=function(r){return new qr(r)},qr=function(r){var e=this;this.activeOperations=Object.create(null),this.createOperationContext=function(r){var n=(r||{}).requestPolicy;return void 0===n&&(n="cache-first"),P({url:e.url,fetchOptions:e.fetchOptions,fetch:e.fetch},r,{requestPolicy:n})},this.createRequestOperation=function(r,n,t){return{key:n.key,query:n.query,variables:n.variables,operationName:r,context:e.createOperationContext(t)}},this.reexecuteOperation=function(r){(e.activeOperations[r.key]||0)>0&&e.dispatchOperation(r)},this.executeQuery=function(r,n){var t=e.createRequestOperation("query",r,n);return e.executeRequestOperation(t)},this.executeSubscription=function(r,n){var t=e.createRequestOperation("subscription",r,n);return e.executeRequestOperation(t)},this.executeMutation=function(r,n){var t=e.createRequestOperation("mutation",r,n);return e.executeRequestOperation(t)},this.url=r.url,this.fetchOptions=r.fetchOptions,this.fetch=r.fetch,this.suspense=!!r.suspense;var n=v(),t=n[1];this.operations$=n[0];var o=[],a=!1;this.dispatchOperation=function(r){if(o.push(r),!a){var e;for(a=!0;void 0!==(e=o.shift());)t(e);a=!1}},this.exchange=br(void 0!==r.exchanges?r.exchanges:kr),this.results$=i(this.exchange({client:this,forward:Or})(this.operations$))};qr.prototype.onOperationStart=function(r){var e=r.key;this.activeOperations[e]=(this.activeOperations[e]||0)+1,this.dispatchOperation(r)},qr.prototype.onOperationEnd=function(r){var e=r.key,n=this.activeOperations[e]||0;(this.activeOperations[e]=n<=0?0:n-1)<=0&&this.dispatchOperation(P({},r,{operationName:"teardown"}))},qr.prototype.executeRequestOperation=function(i){var u=this,c=i.key,s=i.operationName,f=e(this.results$,a(function(r){return r.operation.key===c}));if("mutation"===s)return e(f,d(function(){return u.dispatchOperation(i)}),h(1));var p,v=e(f,d(function(){return u.onOperationStart(i)}),t(function(){return u.onOperationEnd(i)}));return this.suspense?(p=v,r(function(r){var i,a,u=r[1],c=!1,s=e(p,n(r[0]),t(u),o(function(r){void 0===i?a=r:c||(i(r),u(),s())}))[0];if(void 0===a)throw new Promise(function(r){i=r});return function(){c=!0,s()}})):v};var Nr=O(Er({url:"/graphql"})),Sr=Nr.Provider,_r=Nr.Consumer,jr="undefined"!=typeof window?q:N,Pr=function(r){var e=b(!1),n=k(r),t=n[0],o=n[1],i=E(function(r){if(e.current)o(r);else{var n="function"==typeof r?r(t):r;P(t,n)}},[]);function a(){e.current=!1}return jr(function(){return e.current=!0,a},[]),[t,i]},Cr=_.ReactCurrentOwner,Dr=function(r){return r&&(0===r.tag||1===r.tag||2===r.tag)},Qr=function(r){return"Query"===r.name||"Mutation"===r.name||"Subscription"===r.name};function Mr(){var r="Component",e=Cr.current;if(null!==e&&Dr(e)){var n=e.type;Qr(n)&&Dr(e._debugOwner)&&(n=e._debugOwner.type),"function"==typeof n&&(r=n.displayName||n.name||r)}return{meta:{source:r}}}var Rr,Ar="production"!==process.env.NODE_ENV&&Cr?function(){return S(Mr,[])}:function(){},Lr=function(r){var n=Ar(),t=j(Nr),o=Pr({fetching:!1,error:void 0,data:void 0,extensions:void 0}),i=o[1];function a(r){return i({fetching:!1,data:r.data,error:r.error,extensions:r.extensions}),r}return[o[0],E(function(o,u){i({fetching:!0,error:void 0,data:void 0,extensions:void 0});var c=F(r,o);return e(t.executeMutation(c,P({},n,u)),l).then(a)},[t,n,r,i])]},Wr=function(r,e){var n=b(void 0);return S(function(){var t=F(r,e);return void 0!==n.current&&n.current.key===t.key?n.current:(n.current=t,t)},[r,e])};function Fr(r){return P({},r,{fetching:!0})}function Ur(r){return P({},r,{fetching:!1})}!function(r){r[r.WillMount=0]="WillMount",r[r.DidMount=1]="DidMount",r[r.Update=2]="Update"}(Rr||(Rr={}));var $r=function(r){var n=Ar(),t=b(J),i=j(Nr),a=Pr({fetching:!1,data:void 0,error:void 0,extensions:void 0}),u=a[0],c=a[1],s=Wr(r.query,r.variables);function f(r){c({fetching:!1,data:r.data,error:r.error,extensions:r.extensions})}var p=E(function(a){var u;t.current(),c(Fr),u=e(i.executeQuery(s,P({requestPolicy:r.requestPolicy},r.context,a,n)),o(f)),t.current=u[0]},[r.context,r.requestPolicy,i,n,s,c]);function v(){return t.current()}return function(r,e){var n=b(void 0),t=b(Rr.WillMount);t.current===Rr.WillMount&&(t.current=Rr.DidMount,n.current=r()),N(function(){return t.current===Rr.Update?n.current=r():(t.current=Rr.Update,n.current)},e)}(function(){return r.pause?(t.current(),c(Ur),J):(p(),v)},[p,r.pause,c]),[u,p]},Vr=function(r,n){var t=Ar(),i=b(J),a=j(Nr),u=Pr({fetching:!0,error:void 0,data:void 0,extensions:void 0}),c=u[0],s=u[1],f=Wr(r.query,r.variables);function p(r){var e=r.data,t=r.error,o=r.extensions;s(function(r){return{fetching:!0,data:void 0!==n?n(r.data,e):e,error:t,extensions:o}})}var v=E(function(){var n;i.current(),n=e(a.executeSubscription(f,P({},t,r.context)),o(p)),i.current=n[0]},[a,t,n,f,s,r.context]);function d(){return i.current()}return N(function(){return v(),d},[v]),[c]};function Ir(r){var e=r.children,n=Lr(r.query);return e(P({},n[0],{executeMutation:n[1]}))}function Tr(r,e){var n={};for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&e.indexOf(t)<0&&(n[t]=r[t]);if(null!=r&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(t=Object.getOwnPropertySymbols(r);o<t.length;o++)e.indexOf(t[o])<0&&(n[t[o]]=r[t[o]])}return n}function Gr(r){var e=r.children,n=Tr(r,["children"]),t=$r(n);return e(P({},t[0],{executeQuery:t[1]}))}function Hr(r){var e=r.children,n=r.handler,t=Tr(r,["children","handler"]);return e(Vr(t,n)[0])}export{qr as Client,M as CombinedError,_r as Consumer,Nr as Context,Ir as Mutation,Sr as Provider,Gr as Query,Hr as Subscription,tr as cacheExchange,br as composeExchanges,Er as createClient,F as createRequest,vr as debugExchange,dr as dedupExchange,kr as defaultExchanges,Or as fallbackExchangeIO,lr as fetchExchange,H as formatDocument,X as ssrExchange,sr as subscriptionExchange,Lr as useMutation,$r as useQuery,Vr as useSubscription};
//# sourceMappingURL=urql.es.min.js.map
